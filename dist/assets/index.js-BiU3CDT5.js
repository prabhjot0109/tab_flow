const F="/assets/index.js-DMTZA3HJ.js";class H{constructor(r,e){this.dbName=r,this.storeName=e,this.db=null,this.initPromise=this._open()}_open(){return new Promise((r,e)=>{const t=indexedDB.open(this.dbName,1);t.onerror=()=>e(t.error),t.onsuccess=()=>{this.db=t.result,r(this.db)},t.onupgradeneeded=a=>{const o=a.target.result;o.objectStoreNames.contains(this.storeName)||o.createObjectStore(this.storeName)}})}async getAll(){return await this.initPromise,new Promise((r,e)=>{const o=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();o.onsuccess=()=>r(o.result),o.onerror=()=>e(o.error)})}async getAllKeys(){return await this.initPromise,new Promise((r,e)=>{const o=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAllKeys();o.onsuccess=()=>r(o.result),o.onerror=()=>e(o.error)})}async set(r,e){return await this.initPromise,new Promise((t,a)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put(e,r);i.onsuccess=()=>t(),i.onerror=()=>a(i.error)})}async delete(r){return await this.initPromise,new Promise((e,t)=>{const c=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(r);c.onsuccess=()=>e(),c.onerror=()=>t(c.error)})}async clear(){return await this.initPromise,new Promise((r,e)=>{const o=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();o.onsuccess=()=>r(),o.onerror=()=>e(o.error)})}}class L{constructor(r=30,e=20*1024*1024){this.cache=new Map,this.maxTabs=r,this.maxBytes=e,this.currentBytes=0,this.accessOrder=[],this.storage=new H("TabSwitcherDB","screenshots"),this.ready=this._restoreFromStorage()}async _restoreFromStorage(){try{const r=await this.storage.getAllKeys();if(r.length===0)return;const e=await this.storage.getAll();r.forEach((t,a)=>{const o=e[a];o&&o.data&&(this.cache.set(t,o),this.currentBytes+=o.size)}),this.accessOrder=Array.from(this.cache.entries()).sort((t,a)=>a[1].timestamp-t[1].timestamp).map(t=>t[0]),console.log(`[CACHE] Restored ${this.cache.size} screenshots from storage`)}catch(r){console.error("[CACHE] Failed to restore from storage:",r)}}get(r){if(!this.cache.has(r))return null;this.accessOrder=this.accessOrder.filter(t=>t!==r),this.accessOrder.unshift(r);const e=this.cache.get(r);return e.timestamp=Date.now(),this.storage.set(r,e).catch(t=>console.warn("Failed to update timestamp",t)),e}set(r,e){const t=this._estimateSize(e);if(this.cache.has(r)){const o=this.cache.get(r).size;this.currentBytes-=o}for(;(this.cache.size>=this.maxTabs||this.currentBytes+t>this.maxBytes)&&this.cache.size>0;)this._evictLRU();const a={data:e,size:t,timestamp:Date.now()};this.cache.set(r,a),this.currentBytes+=t,this.accessOrder=this.accessOrder.filter(o=>o!==r),this.accessOrder.unshift(r),this.storage.set(r,a).catch(o=>console.error("Failed to persist screenshot",o))}delete(r){if(!this.cache.has(r))return!1;const e=this.cache.get(r);return this.currentBytes-=e.size,this.cache.delete(r),this.accessOrder=this.accessOrder.filter(t=>t!==r),this.storage.delete(r).catch(t=>console.error("Failed to delete screenshot",t)),!0}_evictLRU(){if(this.accessOrder.length===0)return;const r=this.accessOrder.pop(),e=this.cache.get(r);e&&(this.currentBytes-=e.size,this.cache.delete(r),this.storage.delete(r).catch(t=>console.warn("Failed to evict from storage",t)),console.debug(`[LRU] Evicted tab ${r} (${(e.size/1024).toFixed(1)}KB)`))}_estimateSize(r){return Math.ceil(r.length*.75)}getStats(){return{entries:this.cache.size,bytes:this.currentBytes,maxTabs:this.maxTabs,maxBytes:this.maxBytes,utilizationPercent:(this.currentBytes/this.maxBytes*100).toFixed(1)}}clear(){this.cache.clear(),this.accessOrder=[],this.currentBytes=0,this.storage.clear().catch(r=>console.error("Failed to clear storage",r))}}const h={MAX_CACHED_TABS:30,MAX_CACHE_BYTES:20*1024*1024,MAX_SCREENSHOT_SIZE:200*1024,JPEG_QUALITY:60,CAPTURE_DELAY:100,SCREENSHOT_CACHE_DURATION:300*1e3,MAX_CAPTURES_PER_SECOND:2,THROTTLE_INTERVAL:500,PERFORMANCE_LOGGING:!0,QUALITY_TIERS:{HIGH:{quality:60,maxSize:200*1024,label:"High Quality"},NORMAL:{quality:50,maxSize:150*1024,label:"Normal"},PERFORMANCE:{quality:35,maxSize:100*1024,label:"Performance"}},DEFAULT_QUALITY_TIER:"NORMAL"},m=new L(h.MAX_CACHED_TABS,h.MAX_CACHE_BYTES);let g=[];const f=new Map,T=[];let O=0,E=!1,x=null,w=h.DEFAULT_QUALITY_TIER;const I=new Set;let v=!1;const y={overlayOpenTimes:[],captureCount:0,cacheHits:0,cacheMisses:0,recordOverlayOpen(s){this.overlayOpenTimes.push(s),this.overlayOpenTimes.length>100&&this.overlayOpenTimes.shift(),console.log(`[PERF] Overlay open: ${s.toFixed(2)}ms (Target: <100ms)`)},getAverageOverlayTime(){return this.overlayOpenTimes.length===0?0:this.overlayOpenTimes.reduce((r,e)=>r+e,0)/this.overlayOpenTimes.length},logStats(){const s=m.getStats(),r=this.getAverageOverlayTime();console.log("[STATS] ═══════════════════════════════════════"),console.log(`[STATS] Cache: ${s.entries}/${s.maxTabs} tabs`),console.log(`[STATS] Memory: ${(s.bytes/1024/1024).toFixed(2)}MB / ${(s.maxBytes/1024/1024).toFixed(2)}MB (${s.utilizationPercent}%)`),console.log(`[STATS] Captures: ${this.captureCount} (Hits: ${this.cacheHits}, Misses: ${this.cacheMisses})`),console.log(`[STATS] Avg Overlay Open: ${r.toFixed(2)}ms (Target: <100ms)`),console.log("[STATS] ═══════════════════════════════════════")}};function R(s,r=!1){if(T.some(t=>t.tabId===s)||I.has(s))return;const e={tabId:s,timestamp:Date.now()};r?T.unshift(e):T.push(e),P()}async function P(){if(!(E||T.length===0)){for(E=!0;T.length>0;){const r=Date.now()-O;if(r<h.THROTTLE_INTERVAL){const t=h.THROTTLE_INTERVAL-r;await new Promise(a=>setTimeout(a,t))}const e=T.shift();I.add(e.tabId);try{await C(e.tabId)}finally{I.delete(e.tabId)}O=Date.now()}E=!1}}async function C(s,r=null){try{const e=await chrome.tabs.get(s);if(!e.active)return console.debug(`[CAPTURE] Tab ${s} is not active, skipping capture`),null;if(!A(e))return console.debug(`[CAPTURE] Tab ${s} not capturable: ${e.url}`),null;await new Promise(d=>setTimeout(d,h.CAPTURE_DELAY+50));const t=await chrome.tabs.get(s).catch(()=>null);if(!t||!t.active)return console.debug(`[CAPTURE] Tab ${s} no longer active after delay`),null;const a=r||w,o=h.QUALITY_TIERS[a]||h.QUALITY_TIERS.NORMAL,c=performance.now();let i=null;try{i=await chrome.tabs.captureVisibleTab(e.windowId,{format:"jpeg",quality:o.quality})}catch{console.debug("[CAPTURE] First attempt failed, retrying with lower quality");try{await new Promise(u=>setTimeout(u,100)),i=await chrome.tabs.captureVisibleTab(e.windowId,{format:"jpeg",quality:Math.max(30,o.quality-20)})}catch(u){return console.debug(`[CAPTURE] Retry also failed for tab ${s}:`,u.message),null}}if(!i)return console.debug(`[CAPTURE] No screenshot data for tab ${s}`),null;const n=performance.now()-c,l=m._estimateSize(i);return l>o.maxSize*1.5&&console.warn(`[CAPTURE] Screenshot large: ${(l/1024).toFixed(1)}KB (target: ${(o.maxSize/1024).toFixed(1)}KB)`),m.set(s,i),y.captureCount++,h.PERFORMANCE_LOGGING&&console.debug(`[CAPTURE] Tab ${s}: ${n.toFixed(2)}ms, ${(l/1024).toFixed(1)}KB (${o.label})`),i}catch(e){return console.debug(`[CAPTURE] Failed for tab ${s}:`,e.message),null}}function A(s){return!(s.discarded||!s.url||["chrome://","edge://","devtools://","view-source:"].some(e=>s.url.startsWith(e)))}typeof chrome<"u"&&chrome.tabs?(chrome.tabs.onActivated.addListener(async s=>{try{x=s.tabId,_(s.tabId),setTimeout(()=>{R(s.tabId,!0)},200)}catch(r){console.debug("[TAB] Error in onActivated:",r)}}),chrome.tabs.onUpdated.addListener((s,r,e)=>{try{r.status==="complete"&&e.active&&setTimeout(()=>{R(s,!0)},300)}catch(t){console.debug("[TAB] Error in onUpdated:",t)}}),chrome.tabs.onCreated.addListener(s=>{try{f.set(s.id,Date.now())}catch(r){console.debug("[TAB] Error in onCreated:",r)}}),chrome.tabs.onRemoved.addListener(s=>{try{m.delete(s),N(s),f.delete(s),I.delete(s),console.debug(`[CLEANUP] Removed tab ${s} from cache`)}catch(r){console.debug("[TAB] Error in onRemoved:",r)}})):console.error("[INIT] chrome.tabs API not available");function _(s){N(s),g.unshift(s),g.length>h.MAX_CACHED_TABS*2&&(g.length=h.MAX_CACHED_TABS*2),B()}function N(s){const r=g.indexOf(s);r!==-1&&g.splice(r,1)}let p=null;function B(){p&&clearTimeout(p),p=setTimeout(()=>{chrome.storage.local.set({recentTabOrder:g.slice(0,100)}).catch(s=>console.debug("[STORAGE] Failed to save recent order:",s))},500)}async function U(){try{const s=await chrome.storage.local.get(["recentTabOrder"]);if(s.recentTabOrder&&Array.isArray(s.recentTabOrder)){const r=await chrome.tabs.query({}),e=new Set(r.map(t=>t.id));g=s.recentTabOrder.filter(t=>e.has(t)),console.log(`[INIT] Restored ${g.length} recent tab order entries`)}}catch(s){console.debug("[STORAGE] Failed to restore recent order:",s)}v=!0}typeof chrome<"u"&&chrome.commands&&chrome.commands.onCommand.addListener(s=>{(s==="show-tab-switcher"||s==="cycle-next-tab")&&k()});async function k(){m.ready&&await m.ready,v||await U();const s=performance.now();try{const r=await chrome.windows.getCurrent(),e=await chrome.tabs.query({windowId:r.id}),t=Date.now();e.forEach((l,d)=>{f.has(l.id)||f.set(l.id,t-(e.length-d)*1e3)});const a=z(e),o=8,c=a.map((l,d)=>{let u=null;const M=d<o;if(A(l)&&M){const S=m.get(l.id);S?(u=S,y.cacheHits++):y.cacheMisses++}return{id:l.id,title:l.title||"Untitled",url:l.url,favIconUrl:l.favIconUrl,screenshot:u?u.data:null,pinned:l.pinned,index:l.index,active:l.active,audible:l.audible,mutedInfo:l.mutedInfo}}),[i]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!A(i)){console.warn("[INJECT] Cannot open overlay on protected page. Switch to a regular webpage and try again.");return}await $(i.id,{action:"showTabSwitcher",tabs:c,activeTabId:i.id});const n=performance.now()-s;y.recordOverlayOpen(n)}catch(r){console.error("[ERROR] Failed to show tab switcher:",r)}}async function $(s,r,e=1){try{await chrome.tabs.sendMessage(s,r)}catch(t){if(e>0&&t.message.includes("Could not establish connection")){console.log("[INJECT] Content script not ready, injecting...");try{await chrome.scripting.executeScript({target:{tabId:s},files:[F]}),await new Promise(a=>setTimeout(a,150)),await chrome.tabs.sendMessage(s,r)}catch(a){const o=a&&a.message?a.message:"";if(o.includes("cannot be scripted")||o.includes("Cannot access a chrome://")||o.includes("Cannot access a chrome-extension://")||o.includes("Cannot access")&&o.includes("URL"))console.warn("[INJECT] Cannot inject on this page (protected URL). Try on a regular webpage.");else throw a}}else throw t}}function z(s){return[...s].sort((r,e)=>{const t=g.indexOf(r.id),a=g.indexOf(e.id);if(t!==-1&&a!==-1)return t-a;if(t!==-1)return-1;if(a!==-1)return 1;const o=f.get(r.id)||0,c=f.get(e.id)||0;return o!==c?c-o:r.index-e.index})}class D{constructor(){this.storage=chrome.storage.local,this.init()}init(){chrome.webNavigation&&(chrome.webNavigation.onCommitted.addListener(this.onNavigation.bind(this)),chrome.webNavigation.onHistoryStateUpdated&&chrome.webNavigation.onHistoryStateUpdated.addListener(this.onNavigation.bind(this)),chrome.webNavigation.onReferenceFragmentUpdated&&chrome.webNavigation.onReferenceFragmentUpdated.addListener(this.onNavigation.bind(this))),chrome.tabs.onUpdated.addListener(this.onTabUpdated.bind(this)),chrome.tabs.onRemoved.addListener(this.onTabRemoved.bind(this)),this.initializeAllTabs()}async initializeAllTabs(){try{const r=await chrome.tabs.query({});console.log("[HISTORY] Initializing",r.length,"existing tabs");for(const e of r)e.url&&!e.url.startsWith("chrome://")&&!e.url.startsWith("edge://")&&await this.initializeTab(e.id,e.url,e.title)}catch(r){console.error("[HISTORY] Error initializing tabs:",r)}}async initializeTab(r,e,t=""){if(!e||e.startsWith("chrome://")||e.startsWith("edge://"))return;const a=`hist_${r}`;try{if(!(await this.storage.get(a))[a]){const i={stack:[{url:e,title:t||e}],currentIndex:0};await this.storage.set({[a]:i}),console.log("[HISTORY] Initialized tab",r,"with:",t||e.substring(0,50))}}catch(o){console.debug("[HISTORY] Error initializing tab:",r,o)}}async onTabUpdated(r,e,t){e.status==="complete"&&t.url&&(await this.initializeTab(r,t.url,t.title||""),await this.updateCurrentTitle(r,t.url,t.title||"")),e.title&&t.url&&await this.updateCurrentTitle(r,t.url,e.title)}async onNavigation(r){if(r.frameId!==0)return;const e=r.tabId,t=r.url,a=r.transitionQualifiers||[];if(a.includes("reload"))return;const o=a.includes("forward_back");try{const c=await chrome.tabs.get(e);await this.addToHistory(e,t,c.title||"",o)}catch{await this.addToHistory(e,t,"",o)}}async updateCurrentTitle(r,e,t){const a=`hist_${r}`;try{const c=(await this.storage.get(a))[a];if(!c||c.currentIndex<0)return;const i=c.stack[c.currentIndex];i&&(typeof i=="string"?i:i.url)===e&&(c.stack[c.currentIndex]={url:e,title:t},await this.storage.set({[a]:c}))}catch{}}getEntryUrl(r){return typeof r=="string"?r:r?.url}async addToHistory(r,e,t,a){if(!e||e.startsWith("chrome://")||e.startsWith("edge://")||e.startsWith("devtools://"))return;const o=`hist_${r}`;try{let i=(await this.storage.get(o))[o]||{stack:[],currentIndex:-1};const n={url:e,title:t||e},l=(d,u)=>this.getEntryUrl(d)===u;if(i.currentIndex>=0&&i.currentIndex<i.stack.length&&l(i.stack[i.currentIndex],e)){t&&(i.stack[i.currentIndex]=n,await this.storage.set({[o]:i}));return}if(a){let d=-1;for(let u=i.currentIndex-1;u>=0;u--)if(l(i.stack[u],e)){d=u;break}if(d===-1){for(let u=i.currentIndex+1;u<i.stack.length;u++)if(l(i.stack[u],e)){d=u;break}}d!==-1?(i.currentIndex=d,t&&(i.stack[d]=n)):(i.currentIndex>=0&&i.currentIndex<i.stack.length-1&&(i.stack=i.stack.slice(0,i.currentIndex+1)),i.stack.push(n),i.currentIndex=i.stack.length-1)}else i.currentIndex>=0&&i.currentIndex<i.stack.length-1&&(i.stack=i.stack.slice(0,i.currentIndex+1)),(i.currentIndex>=0?this.getEntryUrl(i.stack[i.currentIndex]):null)!==e?(i.stack.push(n),i.currentIndex=i.stack.length-1):t&&i.currentIndex>=0&&(i.stack[i.currentIndex]=n);if(i.stack.length>50){const d=i.stack.length-50;i.stack.splice(0,d),i.currentIndex=Math.max(0,i.currentIndex-d)}await this.storage.set({[o]:i}),console.log("[HISTORY] Updated tab",r,"- stack:",i.stack.length,"items, index:",i.currentIndex)}catch(c){console.error("[HISTORY] Error updating history:",c)}}async onTabRemoved(r){try{await this.storage.remove(`hist_${r}`)}catch{console.debug("[HISTORY] Failed to remove history for tab:",r)}}async getHistory(r){try{const e=`hist_${r}`,a=(await this.storage.get(e))[e];if(console.log("[HISTORY] Getting history for tab",r,"data:",a),!a||!a.stack||a.stack.length===0)return{back:[],forward:[]};const o=n=>typeof n=="string"?{url:n,title:n}:{url:n.url,title:n.title||n.url},c=a.currentIndex>0?a.stack.slice(0,a.currentIndex).reverse().map(o):[],i=a.currentIndex<a.stack.length-1?a.stack.slice(a.currentIndex+1).map(o):[];return console.log("[HISTORY] Returning - back:",c.length,"forward:",i.length),{back:c,forward:i}}catch(e){return console.error("[HISTORY] Error getting history:",e),{back:[],forward:[]}}}async updateIndexByDelta(r,e){const t=`hist_${r}`;try{const o=(await this.storage.get(t))[t];if(!o||!o.stack)return!1;const c=o.currentIndex+e;return c<0||c>=o.stack.length?!1:(o.currentIndex=c,await this.storage.set({[t]:o}),console.log("[HISTORY] Updated currentIndex to",c,"for tab",r),!0)}catch(a){return console.error("[HISTORY] Error updating index by delta:",a),!1}}async navigate(r,e){r&&(await this.updateIndexByDelta(r,e),chrome.scripting.executeScript({target:{tabId:r},func:t=>window.history.go(t),args:[e]}))}}const b=new D;typeof chrome<"u"&&chrome.runtime&&chrome.runtime.onMessage&&chrome.runtime.onMessage.addListener((s,r,e)=>(Y(s,r,e),!0));async function Y(s,r,e){try{if(!s||!s.action){console.error("[ERROR] Invalid message received:",s),e({success:!1,error:"Invalid message format"});return}switch(s.action){case"getRecentlyClosed":try{const a=Math.min(25,typeof s.maxResults=="number"?s.maxResults:10),o=await chrome.sessions.getRecentlyClosed({maxResults:25}),c=[];for(const n of o)if(n.tab)c.push({kind:"tab",sessionId:n.tab.sessionId,lastModified:n.lastModified,title:n.tab.title||"Untitled",url:n.tab.url||"",favIconUrl:n.tab.favIconUrl||""});else if(n.window&&Array.isArray(n.window.tabs))for(const l of n.window.tabs)c.push({kind:"tab",sessionId:l.sessionId||n.window.sessionId,lastModified:n.lastModified,title:l.title||"Untitled",url:l.url||"",favIconUrl:l.favIconUrl||""});else n.window&&n.window.sessionId&&c.push({kind:"window",sessionId:n.window.sessionId,lastModified:n.lastModified,title:"Window",url:"",favIconUrl:""});c.sort((n,l)=>(l.lastModified||0)-(n.lastModified||0));const i=c.slice(0,a);e({success:!0,items:i})}catch(t){console.error("[ERROR] Failed to get recently closed:",t),e({success:!1,error:t.message})}break;case"restoreSession":try{if(!s.sessionId||typeof s.sessionId!="string"){e({success:!1,error:"Invalid sessionId"});return}const t=await chrome.sessions.restore(s.sessionId);e({success:!0,restored:t})}catch(t){console.error("[ERROR] Failed to restore session:",t),e({success:!1,error:t.message})}break;case"switchToTab":if(!s.tabId||typeof s.tabId!="number"){e({success:!1,error:"Invalid tab ID"});return}try{await chrome.tabs.update(s.tabId,{active:!0}),e({success:!0})}catch(t){console.error("[ERROR] Failed to switch to tab:",t),e({success:!1,error:t.message})}break;case"closeTab":if(!s.tabId||typeof s.tabId!="number"){e({success:!1,error:"Invalid tab ID"});return}try{if(!await chrome.tabs.get(s.tabId).catch(()=>null)){console.warn("[WARNING] Tab no longer exists:",s.tabId),e({success:!1,error:"Tab no longer exists"});return}await chrome.tabs.remove(s.tabId),e({success:!0})}catch(t){console.error("[ERROR] Failed to close tab:",t),e({success:!1,error:t.message})}break;case"toggleMute":if(!s.tabId||typeof s.tabId!="number"){e({success:!1,error:"Invalid tab ID"});return}try{const a=!(await chrome.tabs.get(s.tabId)).mutedInfo.muted;await chrome.tabs.update(s.tabId,{muted:a}),e({success:!0,muted:a})}catch(t){console.error("[ERROR] Failed to toggle mute:",t),e({success:!1,error:t.message})}break;case"refreshTabList":try{await k(),e({success:!0})}catch(t){console.error("[ERROR] Failed to refresh tab list:",t),e({success:!1,error:t.message})}break;case"captureTabScreenshot":if(!s.tabId||typeof s.tabId!="number"){e({success:!1,error:"Invalid tab ID"});return}try{const t=await C(s.tabId,null);e({success:!!t,screenshot:t})}catch(t){console.error("[ERROR] Failed to capture screenshot:",t),e({success:!1,error:t.message})}break;case"getCacheStats":try{const t=m.getStats();e({success:!0,stats:t})}catch(t){console.error("[ERROR] Failed to get cache stats:",t),e({success:!1,error:t.message})}break;case"setQualityTier":try{const t=s.tier||h.DEFAULT_QUALITY_TIER;h.QUALITY_TIERS[t]?(w=t,chrome.storage.local.set({qualityTier:t}),console.log(`[SETTINGS] Quality tier changed to: ${t}`),e({success:!0,tier:t})):e({success:!1,error:"Invalid quality tier"})}catch(t){console.error("[ERROR] Failed to set quality tier:",t),e({success:!1,error:t.message})}break;case"GET_TAB_HISTORY":try{const t=r.tab?r.tab.id:s.tabId;if(!t){e({back:[],forward:[]});return}const a=await b.getHistory(t);console.log("[HISTORY] Sending history for tab",t,a),e(a)}catch(t){console.error("[ERROR] Failed to get tab history:",t),e({back:[],forward:[]})}break;case"REPORT_NAVIGATION":try{const t=r.tab?r.tab.id:s.tabId,a=typeof s.url=="string"?s.url:"",o=typeof s.title=="string"?s.title:"",c=typeof s.navType=="string"?s.navType:"navigate";if(!t||!a){e({success:!1,error:"Missing tabId or url"});return}if(c==="title_update"){await b.updateCurrentTitle(t,a,o),e({success:!0,type:"title_update"});return}if(c==="reload"){await b.initializeTab(t,a,o),await b.updateCurrentTitle(t,a,o),e({success:!0,ignored:"reload"});return}const i=c==="back_forward";await b.addToHistory(t,a,o,i),e({success:!0})}catch(t){console.error("[ERROR] Failed to report navigation:",t),e({success:!1,error:t.message})}break;case"NAVIGATE_HISTORY":try{const t=r.tab?r.tab.id:s.tabId;t&&typeof s.delta=="number"?(await b.navigate(t,s.delta),e({success:!0})):e({success:!1,error:"Invalid tabId or delta"})}catch(t){console.error("[ERROR] Failed to navigate history:",t),e({success:!1,error:t.message})}break;default:console.warn("[WARNING] Unknown action:",s.action),e({success:!1,error:"Unknown action"})}}catch(t){console.error("[ERROR] Message handler failed:",t),e({success:!1,error:t.message})}}setInterval(()=>{y.logStats()},6e4);async function G(){try{await U();const s=await chrome.tabs.query({}),r=Date.now();s.forEach((t,a)=>{f.has(t.id)||f.set(t.id,r-(s.length-a)*1e3)});const e=await chrome.windows.getAll();for(const t of e){const[a]=await chrome.tabs.query({windowId:t.id,active:!0});a&&(g.indexOf(a.id)===-1&&_(a.id),x=a.id,setTimeout(()=>{R(a.id,!0)},500))}console.log(`[INIT] Initialized ${s.length} existing tabs, ${g.length} in recent order`)}catch(s){console.error("[INIT] Failed to initialize existing tabs:",s)}}console.log("[INIT] Visual Tab Switcher initialized");chrome.storage.local.get(["qualityTier"],s=>{try{const r=s&&s.qualityTier,e=h&&h.QUALITY_TIERS;r&&e&&e[r]?(w=r,console.log(`[INIT] Loaded quality tier: ${w}`)):console.log("[INIT] Using default quality tier:",w)}catch(r){console.warn("[INIT] Failed to load quality tier, using default:",r&&r.message?r.message:r)}});setTimeout(G,100);console.log("═══════════════════════════════════════════════════════");console.log("Visual Tab Switcher - Performance Optimized");console.log("═══════════════════════════════════════════════════════");console.log(`Cache: Max ${h.MAX_CACHED_TABS} tabs, ${(h.MAX_CACHE_BYTES/1024/1024).toFixed(2)}MB`);console.log("Screenshots: Quality tiers - HIGH: 60%/200KB, NORMAL: 50%/150KB, PERF: 35%/100KB");console.log(`Rate Limit: ${h.MAX_CAPTURES_PER_SECOND} captures/sec`);console.log("Target: <100ms overlay open, <50MB memory, 60fps");console.log("═══════════════════════════════════════════════════════");
